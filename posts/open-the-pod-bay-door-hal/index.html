<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Open The Pod Bay Door, HAL | Fix It In Firmware</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://fixitinfirmware.com/posts/open-the-pod-bay-door-hal/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Ralph Hempel">
<link rel="prev" href="../mission-statements/" title="Mission Statements" type="text/html">
<link rel="next" href="../how-can-i-convince/" title="How Can I Convince ..." type="text/html">
<meta property="og:site_name" content="Fix It In Firmware">
<meta property="og:title" content="Open The Pod Bay Door, HAL">
<meta property="og:url" content="https://fixitinfirmware.com/posts/open-the-pod-bay-door-hal/">
<meta property="og:description" content="Even if you haven't seen &quot;2001: A Space Odyssey&quot;, you have probably heard
someone say &quot;Open the pod bay door, HAL&quot;.
&quot;I can't do that, Dave&quot; is a familiar feeling for embedded systems developers
when y">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-03-10T12:00:00-05:00">
<meta property="article:tag" content="agile">
<meta property="article:tag" content="development">
<meta property="article:tag" content="management">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-transparent
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">Fix It In Firmware</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../pages/about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../pages/resources/" class="nav-link">Resources</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/index.html" class="nav-link">Tags</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Open The Pod Bay Door, HAL</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Ralph Hempel
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2024-03-10T12:00:00-05:00" itemprop="datePublished" title="2024-03-10">2024-03-10</time></a>
            </p>
            
        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p><a href="../../images/accent/Hal_9000_Panel.jpg" class="image-reference" title="foo"><img src="../../images/accent/Hal_9000_Panel.jpg" alt="A picture of the Hal-9000 Front Panel From 2001: A Space Odyssey" title="Hal-9000 Front Panel" class=" align-right"></a></p>
<!-- .. image:: /images/accent/Hal_9000_Panel.jpg
:alt: HAL 9000 Front Panel
:align: right
:width: 200 px -->
<p>Even if you haven't seen "2001: A Space Odyssey", you have probably heard
someone say "Open the pod bay door, HAL".</p>
<p>"I can't do that, Dave" is a familiar feeling for embedded systems developers
when your hardware isn't doing what you think it should.</p>
<p>By now you might have guessed that this article is about how having a HAL
(Hardware Abstraction Layer) for your embedded system makes your life easy,
changing to a new CPU is fast and painless, and the kids all get ballons
and ice cream when your port takes only hours because of your awesome
platform approach.</p>
<p>The reality is always different - what started as a simple port is now a
bit more complicated because a new RTOS is mandated, and there
are new security requirements, and the interface to expander boards is
different, and so on.</p>
<p>All of a sudden, the HAL is the least of your problems because on top
of the architectural changes, you don't have any kind of unit test framework
or continuous integration system to help you move forward with confidence.</p>
<p>Take heart - this is the perfect time to get all of that stuff in place
with a small and focused team. And you can take advantage of the fact that
you don't have any hardware yet to get these critical building blocks in
place.</p>
<p>Let's find out how to approach this starting with the HAL ...</p>
<!-- TEASER_END -->
<nav class="contents" id="in-this-post" role="doc-toc"><p class="topic-title">In this post ...</p>
<ul class="simple">
<li><p><a class="reference internal" href="#your-hal-might-not-be-helping" id="toc-entry-1">Your HAL Might Not Be Helping</a></p></li>
<li><p><a class="reference internal" href="#a-different-approach-to-hal" id="toc-entry-2">A Different Approach to HAL</a></p></li>
<li><p><a class="reference internal" href="#lessons-for-your-next-hal" id="toc-entry-3">Lessons for Your Next HAL</a></p></li>
</ul></nav><section id="your-hal-might-not-be-helping"><h2><a class="toc-backref" href="#toc-entry-1" role="doc-backlink">Your HAL Might Not Be Helping</a></h2>
<p>If you are still worrying about generalizing your hardware in terms of GPIOs
and serial ports, you are probably abstracting too close to the hardware. This
isn't obvious until you start thinking about testabiity and interfaces.</p>
<p>For example, your old hardware used a UART to communicate between the MCU and a
peripheral, and now you want to move up to a higher speed SPI interface. The
simple port just got a bit more complex because even if the message contents
haven't changed much, having a HAL at the hardware later doesn't help at all.</p>
<p>That's why we are going to switch gears and think about an approach to a HAL
that looks at systems. In other words, we don't do:</p>
<div class="code"><pre class="code c"><a id="rest_code_5b7dc28ae858424f818217bb8516ee13-1" name="rest_code_5b7dc28ae858424f818217bb8516ee13-1" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-1"></a><span class="c1">// Open the pod bay door</span>
<a id="rest_code_5b7dc28ae858424f818217bb8516ee13-2" name="rest_code_5b7dc28ae858424f818217bb8516ee13-2" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-2"></a>
<a id="rest_code_5b7dc28ae858424f818217bb8516ee13-3" name="rest_code_5b7dc28ae858424f818217bb8516ee13-3" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-3"></a><span class="n">set_gpio</span><span class="p">(</span><span class="n">PORT_DOOR</span><span class="p">,</span><span class="w"> </span><span class="n">PORT_UNLOCK_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_HIGH</span><span class="p">);</span>
<a id="rest_code_5b7dc28ae858424f818217bb8516ee13-4" name="rest_code_5b7dc28ae858424f818217bb8516ee13-4" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-4"></a><span class="n">set_gpio</span><span class="p">(</span><span class="n">PORT_DOOR</span><span class="p">,</span><span class="w"> </span><span class="n">PORT_DOOR_MOTOR</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_HIGH</span><span class="p">);</span>
<a id="rest_code_5b7dc28ae858424f818217bb8516ee13-5" name="rest_code_5b7dc28ae858424f818217bb8516ee13-5" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-5"></a><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">GPIO_LOW</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">get_gpio</span><span class="p">(</span><span class="n">PORT_DOOR</span><span class="p">,</span><span class="w"> </span><span class="n">PORT_DOOR_OPEN_CONTACT</span><span class="p">)</span>
<a id="rest_code_5b7dc28ae858424f818217bb8516ee13-6" name="rest_code_5b7dc28ae858424f818217bb8516ee13-6" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-6"></a><span class="w">  </span><span class="n">wait</span><span class="p">()</span>
<a id="rest_code_5b7dc28ae858424f818217bb8516ee13-7" name="rest_code_5b7dc28ae858424f818217bb8516ee13-7" href="#rest_code_5b7dc28ae858424f818217bb8516ee13-7"></a><span class="n">set_led</span><span class="p">(</span><span class="n">LED_DOOR_OPEN</span><span class="p">,</span><span class="w"> </span><span class="n">LED_ON</span><span class="p">);</span>
</pre></div>
<p>Instead, we do:</p>
<div class="code"><pre class="code c"><a id="rest_code_0a7460d57dc04350a6348d4b0f6fcca9-1" name="rest_code_0a7460d57dc04350a6348d4b0f6fcca9-1" href="#rest_code_0a7460d57dc04350a6348d4b0f6fcca9-1"></a><span class="n">open_pod_bay_door</span><span class="p">();</span>
</pre></div>
<p>And no, we don't use our hand-rolled GPIO and LED HAL inside
the <cite>open_pod_bay_door()</cite> function, because someday we might
switch to a CAN interface or disconnect the LED handling from
the door opening command.</p>
</section><section id="a-different-approach-to-hal"><h2><a class="toc-backref" href="#toc-entry-2" role="doc-backlink">A Different Approach to HAL</a></h2>
<p>It took me almost 40 years and many frustrated project managers to
realize that we are better off thinking about embedded systems in terms
of their functional blocks - the GPIO and LED interfaces are just
how <em>this</em> version of the hardware implements the functionality.</p>
<p>Why were there frustrated project managers?</p>
<p>Because they were told that this was going to be a simple port, and we
had a good HAL so it should be easy. And someone made an optimistic
guess so that the project could get approved and funded. The true
complexity of the work wasn't obvious until we started to
do more detailed design and discovered hidden dependencies. I'll stop
here and leave that for another article on <a class="reference external" href="https://mdalmijn.com/p/breaking-the-planning-cycle-of-madness">humble planning</a>.</p>
<p>In a recent project, we had to implement similar functionality on two
different MCU families. Instead of abstracting the MCU hardware in yet
another general HAL, we abstracted the functionality like this:</p>
<div class="code"><pre class="code c"><a id="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-1" name="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-1" href="#rest_code_17d7a51c34754f98b4e72c3e27fab5bf-1"></a><span class="c1">// pod_bay_door.h - Pod Bay Door Interface</span>
<a id="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-2" name="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-2" href="#rest_code_17d7a51c34754f98b4e72c3e27fab5bf-2"></a>
<a id="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-3" name="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-3" href="#rest_code_17d7a51c34754f98b4e72c3e27fab5bf-3"></a><span class="kt">int32_t</span><span class="w"> </span><span class="nf">init_pod_bay_door</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a id="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-4" name="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-4" href="#rest_code_17d7a51c34754f98b4e72c3e27fab5bf-4"></a><span class="kt">int32_t</span><span class="w"> </span><span class="nf">open_pod_bay_door</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a id="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-5" name="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-5" href="#rest_code_17d7a51c34754f98b4e72c3e27fab5bf-5"></a><span class="kt">int32_t</span><span class="w"> </span><span class="nf">close_pod_bay_door</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a id="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-6" name="rest_code_17d7a51c34754f98b4e72c3e27fab5bf-6" href="#rest_code_17d7a51c34754f98b4e72c3e27fab5bf-6"></a><span class="kt">int32_t</span><span class="w"> </span><span class="nf">get_pod_bay_door_status</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
<p>We then implemented these 4 functions twice, once for each vendor supplied
HAL interface. This turned out to be good because the door status on one
system was a simple GPIO read, and the other was a remote Hall-effect sensor
on a serial interface.</p>
<p>It wasn't really that much more work - and the secret weapon is that with
this level of abstraction, we were able to implement all of the logic around
the door opening conditions without real hardware. To make things even better
we used a unit test framework and TDD (Test Driven Development) to make
sure we only wrote code the needed to implement the desired functionality.</p>
<p>You might think we had to wait until we had real hardware to integrate
everything, but again, the answer is no. Our chosen MCUs had inexpensive
development boards available, and we were able to get the drivers up and
running to the point where we were confident that when we got the real
boards things would work.</p>
<p>In fact, because we wrote things with testability in mind, we were able to get
the the door opener subsystem working in isolation on the development board.
When the real hardware arrived, we were able to quickly get the door hardware
subsystem running.</p>
</section><section id="lessons-for-your-next-hal"><h2><a class="toc-backref" href="#toc-entry-3" role="doc-backlink">Lessons for Your Next HAL</a></h2>
<p>First, accept the fact that a general HAL might help if you your design
never changes <em>how</em> the MCU accesses perpipherals. But it won't help you
figure out all the <em>other</em> dependencies that you will discover along the
way.</p>
<p>On your next project, consider doing a small scale experiment that should
take no more than a 1 week timebox. Try to break one part of the project
down into its key functions, and then implement any hardware dependencies
using the vendor supplied HAL directly.</p>
<p>For example, I have made an Arduino project called <a class="reference external" href="https://github.com/rhempel/serial9">Serial9</a> to
exchange data on a 9 bit physical serial bus using an 8 bit USB serial
device.</p>
<p>This one was simple enough to not have a test suite, but to be honest the
Python side of the interface in the host was written using TDD and I <em>did</em>
manage to find a few bugs in the Arduino implementation. I will eventually
add a Cpputest suite and the supporting Python library to the repo.</p>
<p>I'll be curious to hear any feedback on this approach to a HAL.</p>
</section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/agile/" rel="tag">agile</a></li>
            <li><a class="tag p-category" href="../../categories/development/" rel="tag">development</a></li>
            <li><a class="tag p-category" href="../../categories/management/" rel="tag">management</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../mission-statements/" rel="prev" title="Mission Statements">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-can-i-convince/" rel="next" title="How Can I Convince ...">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2024         <a href="mailto:rhempel@fixitinfirmware.com">Ralph Hempel</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
